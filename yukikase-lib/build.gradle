import com.github.jengelman.gradle.plugins.shadow.tasks.ShadowJar

/*
 * This file was generated by the Gradle 'init' task.
 */

plugins {
    id 'plugin'
    id("com.gradleup.shadow") version "9.1.0"
}

configurations {
    include
}

dependencies {
    include project(":yukikase-framework")

    compileOnly group: 'net.dmulloy2', name: 'ProtocolLib', version: "+"

    configurations.api.extendsFrom(configurations.include)
}

tasks.register("deploy", ShadowJar) {
    from sourceSets.main.output
    archiveBaseName.set(project.path.replace(":", "-").substring(1))
    archiveVersion.set(version)

    configurations = project.configurations.named("include").map { [it] }

    def projectVersion = version

    if (!System.getenv("CI")) {
        destinationDirectory.set(rootProject.file("server/plugins"))
    }

    doFirst {
        def outDir = destinationDirectory.get().asFile
        def base = archiveBaseName.get()
        if (outDir.exists()) {
            outDir.listFiles()
                    .findAll() { it.name.startsWith(base) && it.name.endsWith(".jar") }
                    .each {
                        it.delete()
                    }
        }

        filesMatching('plugin.yml') {
            expand(version: projectVersion)
        }
    }
}
